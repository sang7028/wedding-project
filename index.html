/**
 * NYSH Wedding Project - ì™„ì „ ê°œì„  Apps Script v2.3
 * 
 * ğŸ¯ v2.3 ì£¼ìš” ê°œì„ ì‚¬í•­:
 * - ìƒˆ ì¹´í…Œê³ ë¦¬ 4ê°œ ì¶”ê°€ (ë²•ì ì ˆì°¨, ìŒí–¥, êµí†µ, ì¶•ì˜ê¸ˆ)
 * - ì‹¤í–‰ì¼ ë¡œì§ ì™„ì „ ìµœì í™”
 * - ì›”ë³„ ì¼ì • ê°œì„  (ê²°ì œì¼ + ì‹¤í–‰ì¼)
 * - Summary ê°œì„  (ì˜ˆìƒ ì´ ì§€ì¶œ, ì§„í–‰ë¥  UI ë°ì´í„°)
 * - ë©”ëª¨ í•­ìƒ í‘œì‹œ ì§€ì›
 * - ê³„ì•½ê¸ˆ/ì”ê¸ˆ ë¶„ë¦¬ ì²˜ë¦¬
 */

// ========== ì„¤ì • ==========
const CONFIG = {
  SHEET_ID: '13Y7RRprcp-lNjInoJHEL3q83FWw_NksjW6bHEOh4qDo',
  WEDDING_DATE: '2026-04-18',
  
  // v2.3 í™•ì¥ ì‹œíŠ¸ êµ¬ì¡° ì •ì˜
  SHEETS: {
    SUMMARY: 'Summary',
    VENUE: 'Venue', 
    FASHION: 'Fashion',
    PHOTO: 'Photo',
    TRAVEL: 'Travel',
    INVITATION: 'Invitation', 
    JEWELRY: 'Jewelry',
    FAMILY: 'Family',
    
    // ğŸ†• ìƒˆë¡œ ì¶”ê°€ëœ ì¹´í…Œê³ ë¦¬
    LEGAL: 'Legal',        // ğŸ“‹ ë²•ì ì ˆì°¨  
    SOUND: 'Sound',        // ğŸµ ìŒí–¥/ì—”í„°í…Œì¸ë¨¼íŠ¸
    TRANSPORT: 'Transport', // ğŸš— êµí†µ/ì°¨ëŸ‰
    GIFT: 'Gift'           // ğŸ’° ì¶•ì˜ê¸ˆê´€ë¦¬
  },
  
  // v2.3 í‘œì¤€ ì»¬ëŸ¼ ì •ì˜ (ì‹¤í–‰ì¼ í¬í•¨)
  COLUMNS: {
    CATEGORY: 'êµ¬ë¶„',
    ITEM: 'í•­ëª©', 
    VENDOR: 'ì—…ì²´ëª…',
    CONTACT: 'ì—°ë½ì²˜',
    DEPOSIT: 'ê³„ì•½ê¸ˆ',
    BALANCE: 'ì”ê¸ˆ', 
    DUE_DATE: 'ê²°ì œì¼',
    EXECUTION_DATE: 'ì‹¤í–‰ì¼',     // ğŸ†• ì‹¤í–‰ì¼ ì»¬ëŸ¼
    STATUS: 'ìƒíƒœ',
    NOTES: 'ë©”ëª¨'
  },
  
  // ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´ì½˜ ë° ì´ë¦„
  CATEGORY_INFO: {
    'Venue': { icon: 'ğŸ°', name: 'ì›¨ë”©í™€' },
    'Fashion': { icon: 'ğŸ‘—', name: 'ì˜ìƒ & ë·°í‹°' },
    'Photo': { icon: 'ğŸ“·', name: 'ì´¬ì˜ & ì˜ìƒ' },
    'Travel': { icon: 'âœˆï¸', name: 'ì‹ í˜¼ì—¬í–‰' },
    'Invitation': { icon: 'ğŸ’Œ', name: 'ì²­ì²©ì¥ & í•˜ê°' },
    'Jewelry': { icon: 'ğŸ’', name: 'ì˜ˆë¬¼ & ë°˜ì§€' },
    'Family': { icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', name: 'ê°€ì¡± í–‰ì‚¬' },
    'Legal': { icon: 'ğŸ“‹', name: 'ë²•ì ì ˆì°¨' },        // ğŸ†•
    'Sound': { icon: 'ğŸµ', name: 'ìŒí–¥/ì—”í„°í…Œì¸ë¨¼íŠ¸' },  // ğŸ†•
    'Transport': { icon: 'ğŸš—', name: 'êµí†µ/ì°¨ëŸ‰' },    // ğŸ†•
    'Gift': { icon: 'ğŸ’°', name: 'ì¶•ì˜ê¸ˆê´€ë¦¬' }         // ğŸ†•
  }
};

// ========== ë©”ì¸ API ì—”ë“œí¬ì¸íŠ¸ ==========
function doGet(e) {
  const startTime = new Date();
  
  try {
    const action = e.parameter.action || 'getSummary';
    const sheet = e.parameter.sheet;
    
    console.log(`ğŸ”„ API í˜¸ì¶œ v2.3: ${action}`);
    
    let result;
    
    switch(action) {
      case 'getSummary':
        result = getSummaryV23();
        break;
      case 'getAllSheets':
        result = getAllSheetsV23();
        break;
      case 'getSheet':
        if (!sheet) throw new Error('ì‹œíŠ¸ ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤');
        result = getSheetDataV23(sheet);
        break;
      case 'getStats':
        result = getWeddingStatsV23();
        break;
      case 'migrate':
        result = migrateToV23();
        break;
      case 'createNewSheets':
        result = createNewCategorySheets();
        break;
      case 'test':
        result = { message: 'API v2.3 í…ŒìŠ¤íŠ¸ ì„±ê³µ!', timestamp: new Date().toISOString() };
        break;
      default:
        throw new Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” ì•¡ì…˜: ${action}`);
    }
    
    const executionTime = new Date() - startTime;
    console.log(`âœ… API ì™„ë£Œ v2.3: ${action} (${executionTime}ms)`);
    
    return createResponse(true, result, `v2.3 ì‹¤í–‰ ì‹œê°„: ${executionTime}ms`);
    
  } catch (error) {
    const executionTime = new Date() - startTime;
    console.error('âŒ API ì˜¤ë¥˜:', error);
    
    return createResponse(false, null, `ì˜¤ë¥˜: ${error.toString()} (${executionTime}ms)`);
  }
}

// ========== ì‘ë‹µ ìƒì„± ==========
function createResponse(success, data, message = '') {
  const response = {
    success: success,
    data: data,
    message: message,
    timestamp: new Date().toISOString(),
    version: '2.3'
  };
  
  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}

// ========== ğŸ¯ ì™„ì „ ìµœì í™”ëœ Summary API v2.3 ==========
function getSummaryV23() {
  try {
    console.log('ğŸ“Š Summary v2.3 ìƒì„± ì‹œì‘...');
    
    const allData = getAllSheetsV23();
    const stats = calculateStatsV23(allData);
    
    return {
      // ê° ì‹œíŠ¸ ë°ì´í„° (11ê°œ ì¹´í…Œê³ ë¦¬)
      Venue: allData.Venue || [],
      Fashion: allData.Fashion || [],
      Photo: allData.Photo || [],
      Travel: allData.Travel || [],
      Invitation: allData.Invitation || [],
      Jewelry: allData.Jewelry || [],
      Family: allData.Family || [],
      Legal: allData.Legal || [],        // ğŸ†•
      Sound: allData.Sound || [],        // ğŸ†•
      Transport: allData.Transport || [], // ğŸ†•
      Gift: allData.Gift || [],          // ğŸ†•
      Summary: allData.Summary || [],
      
      // Summary ì •ë³´
      basic: allData.Summary || [],
      statistics: stats,
      upcomingTasks: getUpcomingTasks3MonthsV23(allData),    
      budgetByCategory: getBudgetByCategoryV23(allData),
      monthlySchedule: getMonthlyScheduleV23(allData), // ğŸ†• ì›”ë³„ ì¼ì • (ì‹¤í–‰ì¼ í¬í•¨)
      categoryInfo: CONFIG.CATEGORY_INFO // ğŸ†• ì¹´í…Œê³ ë¦¬ ì •ë³´
    };
    
  } catch (error) {
    console.error('âŒ Summary ìƒì„± ì˜¤ë¥˜:', error);
    return getDefaultSummary();
  }
}

// ========== ğŸ¯ ìµœì í™”ëœ ë°ì´í„° ë¡œë“œ v2.3 ==========
function getAllSheetsV23() {
  const allData = {};
  
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    console.log(`ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°: ${ss.getName()}`);
    
    Object.values(CONFIG.SHEETS).forEach(sheetName => {
      try {
        const sheet = ss.getSheetByName(sheetName);
        if (sheet) {
          console.log(`ğŸ“‹ ${sheetName} ì²˜ë¦¬ ì¤‘...`);
          allData[sheetName] = processSheetDataV23(sheet, sheetName);
          console.log(`âœ… ${sheetName} ì™„ë£Œ: ${allData[sheetName].length}ê°œ í–‰`);
        } else {
          console.log(`âš ï¸ ${sheetName} ì‹œíŠ¸ ì—†ìŒ - ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”`);
          allData[sheetName] = [];
        }
      } catch (error) {
        console.error(`âŒ ${sheetName} ì²˜ë¦¬ ì‹¤íŒ¨:`, error);
        allData[sheetName] = [];
      }
    });
    
    return allData;
    
  } catch (error) {
    console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    return getDefaultAllData();
  }
}

// ========== ğŸ¯ ì‹œíŠ¸ ë°ì´í„° ì²˜ë¦¬ v2.3 ==========
function processSheetDataV23(sheet, sheetName) {
  try {
    const range = sheet.getDataRange();
    const values = range.getValues();
    
    if (values.length <= 1) return [];
    
    const headers = values[0].map(h => String(h).trim());
    const data = [];
    
    // ì‹¤í–‰ì¼ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    const hasExecutionDate = headers.includes(CONFIG.COLUMNS.EXECUTION_DATE);
    const hasNotes = headers.includes(CONFIG.COLUMNS.NOTES);
    
    console.log(`ğŸ“‹ ${sheetName} ì»¬ëŸ¼ í™•ì¸ - ì‹¤í–‰ì¼: ${hasExecutionDate}, ë©”ëª¨: ${hasNotes}`);
    
    for (let i = 1; i < values.length; i++) {
      try {
        const row = {};
        let hasData = false;
        
        // ê¸°ë³¸ ë°ì´í„° ë§¤í•‘
        for (let j = 0; j < headers.length; j++) {
          const value = values[i][j];
          const cleanValue = cleanCellValue(value);
          row[headers[j]] = cleanValue;
          
          if (cleanValue !== '') hasData = true;
        }
        
        if (hasData && sheetName !== CONFIG.SHEETS.SUMMARY) {
          // ê³„ì‚°ëœ í•„ë“œ ì¶”ê°€
          row._totalBudget = calculateRowBudgetV23(row);
          row._deposit = parseFloat(row[CONFIG.COLUMNS.DEPOSIT]) || 0;
          row._balance = parseFloat(row[CONFIG.COLUMNS.BALANCE]) || 0;
          row._isCompleted = isStatusCompletedV23(row[CONFIG.COLUMNS.STATUS]);
          
          // ë‚ ì§œ íŒŒì‹± (ì•ˆì „í•˜ê²Œ)
          row._executionDate = hasExecutionDate ? 
            parseDateStringV23(row[CONFIG.COLUMNS.EXECUTION_DATE]) : null;
          row._dueDate = parseDateStringV23(row[CONFIG.COLUMNS.DUE_DATE]);
          row._targetDate = row._executionDate || row._dueDate || null;
          
          // ë©”ëª¨ ì²˜ë¦¬
          row._hasNotes = hasNotes && row[CONFIG.COLUMNS.NOTES] && 
                         String(row[CONFIG.COLUMNS.NOTES]).trim() !== '';
          
          data.push(row);
        } else if (hasData) {
          data.push(row);
        }
        
      } catch (rowError) {
        console.error(`í–‰ ì²˜ë¦¬ ì˜¤ë¥˜ (${sheetName} ${i+1}):`, rowError);
      }
    }
    
    return data;
    
  } catch (error) {
    console.error(`ì‹œíŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜ (${sheetName}):`, error);
    return [];
  }
}

// ========== ğŸ†• ì›”ë³„ ì¼ì • v2.3 (ì‹¤í–‰ì¼ í¬í•¨) ==========
function getMonthlyScheduleV23(allData) {
  const schedule = {};
  const today = new Date();
  const weddingDate = new Date(CONFIG.WEDDING_DATE);
  
  if (!allData || typeof allData !== 'object') {
    return {};
  }
  
  Object.keys(allData).forEach(category => {
    if (category === CONFIG.SHEETS.SUMMARY) return;
    
    const categoryData = allData[category];
    if (!Array.isArray(categoryData)) return;
    
    categoryData.forEach(row => {
      if (!row || typeof row !== 'object' || row._isCompleted) return;
      
      const paymentDate = row._dueDate;
      if (!paymentDate || !(paymentDate instanceof Date)) return;
      if (paymentDate < today || paymentDate > weddingDate) return;
      
      const monthKey = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
      
      if (!schedule[monthKey]) {
        schedule[monthKey] = [];
      }
      
      const budget = Math.round((row._totalBudget || 0) / 10000);
      
      if (budget > 0) {
        schedule[monthKey].push({
          category: category,
          item: row[CONFIG.COLUMNS.ITEM] || '',
          paymentDate: formatDateV23(paymentDate),
          executionDate: row._executionDate ? formatDateV23(row._executionDate) : '', // ğŸ†• ì‹¤í–‰ì¼
          budget: budget,
          deposit: Math.round((row._deposit || 0) / 10000),
          balance: Math.round((row._balance || 0) / 10000),
          status: row[CONFIG.COLUMNS.STATUS] || 'ë¯¸ì •',
          vendor: row[CONFIG.COLUMNS.VENDOR] || '',
          notes: row[CONFIG.COLUMNS.NOTES] || '' // ğŸ†• ë©”ëª¨
        });
      }
    });
  });
  
  // ê° ì›”ë³„ë¡œ ê²°ì œì¼ ìˆœ ì •ë ¬
  Object.keys(schedule).forEach(monthKey => {
    if (Array.isArray(schedule[monthKey])) {
      schedule[monthKey].sort((a, b) => new Date(a.paymentDate) - new Date(b.paymentDate));
    }
  });
  
  return schedule;
}

// ========== ğŸ†• 3ê°œì›” ë‚´ í• ì¼ v2.3 (ì‹¤í–‰ì¼ ìš°ì„ ) ==========
function getUpcomingTasks3MonthsV23(allData) {
  const tasks = [];
  const today = new Date();
  const threeMonthsLater = new Date(today.getTime() + (90 * 24 * 60 * 60 * 1000));
  
  if (!allData || typeof allData !== 'object') {
    return [];
  }
  
  Object.keys(allData).forEach(category => {
    if (category === CONFIG.SHEETS.SUMMARY) return;
    
    const categoryData = allData[category];
    if (!Array.isArray(categoryData)) return;
    
    categoryData.forEach(row => {
      if (!row || typeof row !== 'object' || row._isCompleted) return;
      
      const targetDate = row._targetDate;
      if (!targetDate || !(targetDate instanceof Date)) return;
      
      if (targetDate <= threeMonthsLater) {
        tasks.push({
          category: category,
          item: row[CONFIG.COLUMNS.ITEM] || '',
          paymentDate: row._dueDate ? formatDateV23(row._dueDate) : '',
          executionDate: row._executionDate ? formatDateV23(row._executionDate) : '', // ğŸ†•
          status: row[CONFIG.COLUMNS.STATUS] || '',
          priority: calculatePriorityV23(targetDate, today),
          vendor: row[CONFIG.COLUMNS.VENDOR] || '',
          targetDate: targetDate,
          notes: row[CONFIG.COLUMNS.NOTES] || '' // ğŸ†• ë©”ëª¨
        });
      }
    });
  });
  
  return tasks
    .sort((a, b) => {
      const dateA = a.targetDate instanceof Date ? a.targetDate : new Date(0);
      const dateB = b.targetDate instanceof Date ? b.targetDate : new Date(0);
      return dateA - dateB;
    })
    .slice(0, 12); // ë” ë§ì´ í‘œì‹œ
}

// ========== ğŸ¯ í†µê³„ ê³„ì‚° v2.3 (ì˜ˆìƒ ì´ ì§€ì¶œ) ==========
function calculateStatsV23(allData) {
  try {
    let totalExpectedExpense = 0; // ğŸ†• ì˜ˆìƒ ì´ ì§€ì¶œ
    let currentExpense = 0; 
    let completedTasks = 0;
    let totalTasks = 0;
    
    const categoryStats = {};
    
    if (!allData || typeof allData !== 'object') {
      return getDefaultStats();
    }
    
    Object.keys(allData).forEach(sheetName => {
      if (sheetName === CONFIG.SHEETS.SUMMARY) return;
      
      const data = allData[sheetName];
      
      if (!Array.isArray(data)) {
        categoryStats[sheetName] = { 
          budget: 0, completed: 0, total: 0, progress: 0,
          icon: CONFIG.CATEGORY_INFO[sheetName]?.icon || 'ğŸ“‹',
          name: CONFIG.CATEGORY_INFO[sheetName]?.name || sheetName
        };
        return;
      }
      
      let categoryBudget = 0;
      let categoryCompleted = 0;
      
      data.forEach(row => {
        if (!row || typeof row !== 'object') return;
        
        const budget = typeof row._totalBudget === 'number' ? row._totalBudget : 0;
        totalExpectedExpense += budget; // ğŸ†• ëª¨ë“  ì˜ˆì‚° í•©ê³„
        
        if (row._isCompleted === true) {
          currentExpense += budget;
          completedTasks++;
          categoryCompleted++;
        }
        
        totalTasks++;
        categoryBudget += budget;
      });
      
      categoryStats[sheetName] = {
        budget: categoryBudget,
        completed: categoryCompleted,
        total: data.length,
        progress: data.length > 0 ? Math.round((categoryCompleted / data.length) * 100) : 0,
        icon: CONFIG.CATEGORY_INFO[sheetName]?.icon || 'ğŸ“‹',
        name: CONFIG.CATEGORY_INFO[sheetName]?.name || sheetName
      };
    });
    
    // D-Day ê³„ì‚°
    const weddingDate = new Date(CONFIG.WEDDING_DATE);
    const today = new Date();
    const daysLeft = Math.ceil((weddingDate - today) / (1000 * 60 * 60 * 24));
    
    return {
      daysLeft: daysLeft > 0 ? daysLeft : 0,
      totalExpectedExpense: Math.round(totalExpectedExpense / 10000), // ğŸ†• ì˜ˆìƒ ì´ ì§€ì¶œ
      currentExpense: Math.round(currentExpense / 10000),
      completedTasks: completedTasks,
      totalTasks: totalTasks,
      overallProgress: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0,
      categoryStats: categoryStats,
      expenseUtilization: totalExpectedExpense > 0 ? 
        Math.round((currentExpense / totalExpectedExpense) * 100) : 0
    };
    
  } catch (error) {
    console.error('í†µê³„ ê³„ì‚° ì˜¤ë¥˜:', error);
    return getDefaultStats();
  }
}

// ========== ğŸš€ v2.3 ë§ˆì´ê·¸ë ˆì´ì…˜ (ìƒˆ ì¹´í…Œê³ ë¦¬ + ì‹¤í–‰ì¼) ==========
function migrateToV23() {
  console.log('ğŸš€ v2.3 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...');
  
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const results = [];
    
    // 1. ìƒˆ ì¹´í…Œê³ ë¦¬ ì‹œíŠ¸ ìƒì„±
    results.push(createNewCategorySheets());
    
    // 2. ê¸°ì¡´ ì‹œíŠ¸ì— ì‹¤í–‰ì¼ ì»¬ëŸ¼ ì¶”ê°€
    const allSheets = Object.values(CONFIG.SHEETS).filter(name => name !== 'Summary');
    
    allSheets.forEach(sheetName => {
      try {
        const sheet = ss.getSheetByName(sheetName);
        if (sheet) {
          const result = addExecutionDateColumnV23(sheet, sheetName);
          results.push(result);
        }
      } catch (error) {
        console.error(`${sheetName} ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:`, error);
        results.push(`âŒ ${sheetName}: ${error.message}`);
      }
    });
    
    // 3. Summary ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    results.push(updateSummarySheetV23(ss));
    
    console.log('âœ… v2.3 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ');
    
    return {
      success: true,
      message: 'v2.3 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ (ìƒˆ ì¹´í…Œê³ ë¦¬ + ì‹¤í–‰ì¼)',
      results: results,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨:', error);
    return {
      success: false,
      message: error.toString(),
      results: [],
      timestamp: new Date().toISOString()
    };
  }
}

// ========== ğŸ†• ìƒˆ ì¹´í…Œê³ ë¦¬ ì‹œíŠ¸ ìƒì„± ==========
function createNewCategorySheets() {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const newCategories = ['Legal', 'Sound', 'Transport', 'Gift'];
    const results = [];
    
    newCategories.forEach(categoryName => {
      try {
        let sheet = ss.getSheetByName(categoryName);
        
        if (!sheet) {
          // ìƒˆ ì‹œíŠ¸ ìƒì„±
          sheet = ss.insertSheet(categoryName);
          
          // í—¤ë” ì„¤ì •
          const headers = Object.values(CONFIG.COLUMNS);
          sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
          
          // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
          const headerRange = sheet.getRange(1, 1, 1, headers.length);
          headerRange.setBackground('#667eea')
                    .setFontColor('white')
                    .setFontWeight('bold')
                    .setFontSize(11)
                    .setHorizontalAlignment('center');
          
          // ìƒíƒœ ì»¬ëŸ¼ì— ë°ì´í„° ê²€ì¦ ì¶”ê°€
          const statusColIndex = headers.indexOf(CONFIG.COLUMNS.STATUS) + 1;
          if (statusColIndex > 0) {
            const validation = SpreadsheetApp.newDataValidation()
              .requireValueInList(['ì™„ë£Œ', 'ì§„í–‰ì¤‘', 'ë¯¸ì •'], true)
              .setAllowInvalid(false)
              .setHelpText('ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”: ì™„ë£Œ, ì§„í–‰ì¤‘, ë¯¸ì •')
              .build();
            
            const statusRange = sheet.getRange(2, statusColIndex, 50, 1);
            statusRange.setDataValidation(validation);
          }
          
          // ì»¬ëŸ¼ ë„ˆë¹„ ìë™ ì¡°ì •
          sheet.autoResizeColumns(1, headers.length);
          
          results.push(`âœ… ${categoryName}: ìƒˆ ì‹œíŠ¸ ìƒì„± ì™„ë£Œ`);
        } else {
          results.push(`âš ï¸ ${categoryName}: ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‹œíŠ¸`);
        }
        
      } catch (error) {
        console.error(`${categoryName} ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨:`, error);
        results.push(`âŒ ${categoryName}: ${error.message}`);
      }
    });
    
    return results.join(', ');
    
  } catch (error) {
    console.error('ìƒˆ ì¹´í…Œê³ ë¦¬ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
    return `âŒ ìƒˆ ì¹´í…Œê³ ë¦¬ ì‹œíŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`;
  }
}

// ========== ì‹¤í–‰ì¼ ì»¬ëŸ¼ ì¶”ê°€ v2.3 ==========
function addExecutionDateColumnV23(sheet, sheetName) {
  try {
    const range = sheet.getDataRange();
    const values = range.getValues();
    
    if (values.length === 0) {
      return `âš ï¸ ${sheetName}: ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤`;
    }
    
    const headers = values[0];
    
    // ì´ë¯¸ ì‹¤í–‰ì¼ ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
    if (headers.includes('ì‹¤í–‰ì¼')) {
      return `âœ… ${sheetName}: ì‹¤í–‰ì¼ ì»¬ëŸ¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤`;
    }
    
    // ê²°ì œì¼ ì»¬ëŸ¼ ìœ„ì¹˜ ì°¾ê¸°
    const dueDateIndex = headers.indexOf('ê²°ì œì¼');
    
    if (dueDateIndex === -1) {
      return `âš ï¸ ${sheetName}: ê²°ì œì¼ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`;
    }
    
    // ì‹¤í–‰ì¼ ì»¬ëŸ¼ì„ ê²°ì œì¼ ë‹¤ìŒì— ì‚½ì…
    const insertIndex = dueDateIndex + 2;
    
    // ì»¬ëŸ¼ ì‚½ì…
    sheet.insertColumnAfter(dueDateIndex + 1);
    
    // í—¤ë” ì„¤ì •
    sheet.getRange(1, insertIndex).setValue('ì‹¤í–‰ì¼');
    
    // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
    const headerRange = sheet.getRange(1, insertIndex);
    headerRange.setBackground('#667eea')
              .setFontColor('white')
              .setFontWeight('bold')
              .setFontSize(11)
              .setHorizontalAlignment('center');
    
    // ìƒíƒœ ì»¬ëŸ¼ ë“œë¡­ë‹¤ìš´ ë‹¤ì‹œ ì„¤ì • (ì»¬ëŸ¼ì´ ë°€ë ¸ìœ¼ë¯€ë¡œ)
    const statusColIndex = headers.indexOf('ìƒíƒœ') + (insertIndex <= headers.indexOf('ìƒíƒœ') + 1 ? 2 : 1);
    if (statusColIndex > 0) {
      const statusRange = sheet.getRange(2, statusColIndex, sheet.getLastRow() - 1, 1);
      const validation = SpreadsheetApp.newDataValidation()
        .requireValueInList(['ì™„ë£Œ', 'ì§„í–‰ì¤‘', 'ë¯¸ì •'], true)
        .setAllowInvalid(false)
        .setHelpText('ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”: ì™„ë£Œ, ì§„í–‰ì¤‘, ë¯¸ì •')
        .build();
      
      statusRange.setDataValidation(validation);
    }
    
    // ì»¬ëŸ¼ ë„ˆë¹„ ìë™ ì¡°ì •
    sheet.autoResizeColumns(1, sheet.getLastColumn());
    
    return `âœ… ${sheetName}: ì‹¤í–‰ì¼ ì»¬ëŸ¼ ì¶”ê°€ ì™„ë£Œ`;
    
  } catch (error) {
    console.error(`ì‹¤í–‰ì¼ ì»¬ëŸ¼ ì¶”ê°€ ì‹¤íŒ¨ (${sheetName}):`, error);
    return `âŒ ${sheetName}: ${error.message}`;
  }
}

// ========== Summary ì‹œíŠ¸ ì—…ë°ì´íŠ¸ v2.3 ==========
function updateSummarySheetV23(ss) {
  try {
    let sheet = ss.getSheetByName('Summary');
    
    if (!sheet) {
      sheet = ss.insertSheet('Summary');
    }
    
    // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
    sheet.clear();
    
    // v2.3 Summary êµ¬ì¡° ìƒì„± (11ê°œ ì¹´í…Œê³ ë¦¬ í¬í•¨)
    const summaryData = [
      ['í•­ëª©', 'ê°’', 'í•­ëª©', 'ê°’'],
      ['D-Day', '=DAYS("2026-04-18",TODAY())&"ì¼"', 'ì „ì²´ì§„í–‰ë¥ ', '=ROUND(AVERAGE(D13:D23),0)&"%"'],
      ['ì˜ˆìƒì´ì§€ì¶œ', '=ROUND((SUM(Venue!E:E,Venue!F:F,Fashion!E:E,Fashion!F:F,Photo!E:E,Photo!F:F,Travel!E:E,Travel!F:F,Invitation!E:E,Invitation!F:F,Jewelry!E:E,Jewelry!F:F,Family!E:E,Family!F:F,Legal!E:E,Legal!F:F,Sound!E:E,Sound!F:F,Transport!E:E,Transport!F:F,Gift!E:E,Gift!F:F))/10000,0)&"ë§Œì›"', 'í˜„ì¬ì§€ì¶œ', '=ROUND((SUMIFS(Venue!E:E,Venue!I:I,"*ì™„ë£Œ*")+SUMIFS(Venue!F:F,Venue!I:I,"*ì™„ë£Œ*")+SUMIFS(Fashion!E:E,Fashion!I:I,"*ì™„ë£Œ*")+SUMIFS(Fashion!F:F,Fashion!I:I,"*ì™„ë£Œ*")+SUMIFS(Photo!E:E,Photo!I:I,"*ì™„ë£Œ*")+SUMIFS(Photo!F:F,Photo!I:I,"*ì™„ë£Œ*")+SUMIFS(Travel!E:E,Travel!I:I,"*ì™„ë£Œ*")+SUMIFS(Travel!F:F,Travel!I:I,"*ì™„ë£Œ*")+SUMIFS(Invitation!E:E,Invitation!I:I,"*ì™„ë£Œ*")+SUMIFS(Invitation!F:F,Invitation!I:I,"*ì™„ë£Œ*")+SUMIFS(Jewelry!E:E,Jewelry!I:I,"*ì™„ë£Œ*")+SUMIFS(Jewelry!F:F,Jewelry!I:I,"*ì™„ë£Œ*")+SUMIFS(Family!E:E,Family!I:I,"*ì™„ë£Œ*")+SUMIFS(Family!F:F,Family!I:I,"*ì™„ë£Œ*")+SUMIFS(Legal!E:E,Legal!I:I,"*ì™„ë£Œ*")+SUMIFS(Legal!F:F,Legal!I:I,"*ì™„ë£Œ*")+SUMIFS(Sound!E:E,Sound!I:I,"*ì™„ë£Œ*")+SUMIFS(Sound!F:F,Sound!I:I,"*ì™„ë£Œ*")+SUMIFS(Transport!E:E,Transport!I:I,"*ì™„ë£Œ*")+SUMIFS(Transport!F:F,Transport!I:I,"*ì™„ë£Œ*")+SUMIFS(Gift!E:E,Gift!I:I,"*ì™„ë£Œ*")+SUMIFS(Gift!F:F,Gift!I:I,"*ì™„ë£Œ*"))/10000,0)&"ë§Œì›"'],
      ['ì›¨ë”©í™€', 'ê°•ë³€ì›¨ë”©ìŠ¤í€˜ì–´', 'ì›¨ë”©ë‚ ì§œ', '2026.4.18'],
      ['ì‹ ë¶€', 'ê¹€ë‚˜ì˜', 'ì‹ ë‘', 'ì´ìƒí˜„'],
      ['í”Œë˜ë„ˆ', 'ë² ë¦¬êµ¿ ë´„ë„ì˜ì‹¤ì¥', 'ì§„í–‰ìƒíƒœ', '=IF(D2="100%","ì™„ë£Œ!","ì§„í–‰ì¤‘")'],
      ['', '', '', ''],
      ['ì¹´í…Œê³ ë¦¬ë³„ í˜„í™© (v2.3)', '', '', ''],
      ['ì¹´í…Œê³ ë¦¬', 'ì™„ë£Œ í˜„í™©', '', 'ì§„í–‰ë¥ '],
      ['ğŸ° ì›¨ë”©í™€', '=COUNTIFS(Venue!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Venue!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Venue!A:A)>1,ROUND(COUNTIFS(Venue!I:I,"*ì™„ë£Œ*")/(COUNTA(Venue!A:A)-1)*100,0),0)'],
      ['ğŸ‘— ì˜ìƒë·°í‹°', '=COUNTIFS(Fashion!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Fashion!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Fashion!A:A)>1,ROUND(COUNTIFS(Fashion!I:I,"*ì™„ë£Œ*")/(COUNTA(Fashion!A:A)-1)*100,0),0)'],
      ['ğŸ“· ì´¬ì˜ì˜ìƒ', '=COUNTIFS(Photo!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Photo!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Photo!A:A)>1,ROUND(COUNTIFS(Photo!I:I,"*ì™„ë£Œ*")/(COUNTA(Photo!A:A)-1)*100,0),0)'],
      ['âœˆï¸ ì‹ í˜¼ì—¬í–‰', '=COUNTIFS(Travel!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Travel!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Travel!A:A)>1,ROUND(COUNTIFS(Travel!I:I,"*ì™„ë£Œ*")/(COUNTA(Travel!A:A)-1)*100,0),0)'],
      ['ğŸ’Œ ì²­ì²©ì¥', '=COUNTIFS(Invitation!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Invitation!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Invitation!A:A)>1,ROUND(COUNTIFS(Invitation!I:I,"*ì™„ë£Œ*")/(COUNTA(Invitation!A:A)-1)*100,0),0)'],
      ['ğŸ’ ì˜ˆë¬¼ë°˜ì§€', '=COUNTIFS(Jewelry!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Jewelry!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Jewelry!A:A)>1,ROUND(COUNTIFS(Jewelry!I:I,"*ì™„ë£Œ*")/(COUNTA(Jewelry!A:A)-1)*100,0),0)'],
      ['ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±í–‰ì‚¬', '=COUNTIFS(Family!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Family!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Family!A:A)>1,ROUND(COUNTIFS(Family!I:I,"*ì™„ë£Œ*")/(COUNTA(Family!A:A)-1)*100,0),0)'],
      ['ğŸ“‹ ë²•ì ì ˆì°¨', '=COUNTIFS(Legal!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Legal!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Legal!A:A)>1,ROUND(COUNTIFS(Legal!I:I,"*ì™„ë£Œ*")/(COUNTA(Legal!A:A)-1)*100,0),0)'],
      ['ğŸµ ìŒí–¥ì—”í„°', '=COUNTIFS(Sound!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Sound!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Sound!A:A)>1,ROUND(COUNTIFS(Sound!I:I,"*ì™„ë£Œ*")/(COUNTA(Sound!A:A)-1)*100,0),0)'],
      ['ğŸš— êµí†µì°¨ëŸ‰', '=COUNTIFS(Transport!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Transport!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Transport!A:A)>1,ROUND(COUNTIFS(Transport!I:I,"*ì™„ë£Œ*")/(COUNTA(Transport!A:A)-1)*100,0),0)'],
      ['ğŸ’° ì¶•ì˜ê¸ˆê´€ë¦¬', '=COUNTIFS(Gift!I:I,"*ì™„ë£Œ*")&"/"&(COUNTA(Gift!A:A)-1)&" ì™„ë£Œ"', '', '=IF(COUNTA(Gift!A:A)>1,ROUND(COUNTIFS(Gift!I:I,"*ì™„ë£Œ*")/(COUNTA(Gift!A:A)-1)*100,0),0)']
    ];
    
    // ë°ì´í„° ì…ë ¥
    sheet.getRange(1, 1, summaryData.length, 4).setValues(summaryData);
    
    // ìŠ¤íƒ€ì¼ ì ìš©
    applySummaryStylesV23(sheet);
    
    return 'âœ… Summary: v2.3 êµ¬ì¡°ë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ (11ê°œ ì¹´í…Œê³ ë¦¬)';
    
  } catch (error) {
    console.error('Summary ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    return `âŒ Summary: ${error.message}`;
  }
}

// ========== Summary ìŠ¤íƒ€ì¼ ì ìš© v2.3 ==========
function applySummaryStylesV23(sheet) {
  // í—¤ë” ìŠ¤íƒ€ì¼
  const headerRange = sheet.getRange('A1:D1');
  headerRange.setBackground('#667eea')
           .setFontColor('white')
           .setFontWeight('bold')
           .setFontSize(12);
  
  // ì¹´í…Œê³ ë¦¬ ì œëª© ìŠ¤íƒ€ì¼
  const categoryHeaderRange = sheet.getRange('A9:D9');
  categoryHeaderRange.setBackground('#f8f9fa')
                    .setFontWeight('bold')
                    .setFontSize(14);
  
  // ì¹´í…Œê³ ë¦¬ ì„œë¸Œí—¤ë” ìŠ¤íƒ€ì¼
  const subHeaderRange = sheet.getRange('A10:D10');
  subHeaderRange.setBackground('#e9ecef')
               .setFontWeight('bold')
               .setFontSize(10);
  
  // ì¡°ê±´ë¶€ ì„œì‹ (ì§„í–‰ë¥ ) - 11ê°œ ì¹´í…Œê³ ë¦¬ ë°˜ì˜
  const progressRange = sheet.getRange('D11:D21');
  
  const rules = [
    SpreadsheetApp.newConditionalFormatRule()
      .whenNumberEqualTo(100)
      .setBackground('#d1e7dd')
      .setFontColor('#0f5132')
      .setRanges([progressRange])
      .build(),
    SpreadsheetApp.newConditionalFormatRule()
      .whenNumberGreaterThanOrEqualTo(50)
      .setBackground('#fff3cd')
      .setFontColor('#664d03')
      .setRanges([progressRange])
      .build(),
    SpreadsheetApp.newConditionalFormatRule()
      .whenNumberLessThan(50)
      .setBackground('#f8d7da')
      .setFontColor('#721c24')
      .setRanges([progressRange])
      .build()
  ];
  
  sheet.setConditionalFormatRules(rules);
  sheet.autoResizeColumns(1, 4);
}

// ========== ê°œë³„ ì‹œíŠ¸ ë°ì´í„° v2.3 ==========
function getSheetDataV23(sheetName) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
      throw new Error(`ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${sheetName}`);
    }
    
    return processSheetDataV23(sheet, sheetName);
    
  } catch (error) {
    console.error(`ì‹œíŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (${sheetName}):`, error);
    return [];
  }
}

// ========== í†µê³„ë§Œ ë°˜í™˜ v2.3 ==========
function getWeddingStatsV23() {
  try {
    const allData = getAllSheetsV23();
    return calculateStatsV23(allData);
  } catch (error) {
    console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
    return getDefaultStats();
  }
}

// ========== ì¹´í…Œê³ ë¦¬ë³„ ì˜ˆì‚° v2.3 ==========
function getBudgetByCategoryV23(allData) {
  const budgetByCategory = {};
  
  try {
    if (!allData || typeof allData !== 'object') {
      return {};
    }
    
    Object.keys(allData).forEach(category => {
      if (category === CONFIG.SHEETS.SUMMARY) return;
      
      const categoryData = allData[category];
      if (!Array.isArray(categoryData)) return;
      
      const totalBudget = categoryData.reduce((sum, row) => {
        if (!row || typeof row !== 'object') return sum;
        const budget = typeof row._totalBudget === 'number' ? row._totalBudget : 0;
        return sum + budget;
      }, 0);
      
      if (totalBudget > 0) {
        budgetByCategory[category] = Math.round(totalBudget / 10000);
      }
    });
    
    return budgetByCategory;
    
  } catch (error) {
    console.error('ì¹´í…Œê³ ë¦¬ë³„ ì˜ˆì‚° ê³„ì‚° ì˜¤ë¥˜:', error);
    return {};
  }
}

// ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ v2.3 ==========

function cleanCellValue(value) {
  if (value === null || value === undefined) return '';
  if (typeof value === 'number') return value;
  if (value instanceof Date) return formatDateV23(value);
  return String(value).trim();
}

function calculateRowBudgetV23(row) {
  const deposit = parseFloat(row[CONFIG.COLUMNS.DEPOSIT]) || 0;
  const balance = parseFloat(row[CONFIG.COLUMNS.BALANCE]) || 0;
  return deposit + balance;
}

function isStatusCompletedV23(status) {
  if (!status) return false;
  return String(status).includes('ì™„ë£Œ');
}

function calculatePriorityV23(targetDate, today) {
  const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
  
  if (daysUntil < 0) return 100;
  if (daysUntil <= 7) return 95;
  if (daysUntil <= 14) return 90;
  if (daysUntil <= 30) return 80;
  if (daysUntil <= 60) return 70;
  return 60;
}

function parseDateStringV23(dateStr) {
  if (!dateStr) return null;
  
  const str = String(dateStr).trim();
  if (!str) return null;
  
  const patterns = [
    /(\d{4})\.(\d{1,2})\.(\d{1,2})/,
    /(\d{4})-(\d{1,2})-(\d{1,2})/,
    /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
    /(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/,
    /(\d{4})ë…„\s*(\d{1,2})ì›”/,
    /(\d{1,2})ì›”\s*(\d{1,2})ì¼/,
    /(\d{1,2})ì›”/
  ];
  
  for (let pattern of patterns) {
    const match = str.match(pattern);
    if (match) {
      if (pattern.source.includes('ë…„.*ì›”.*ì¼')) {
        return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
      } else if (pattern.source.includes('ë…„.*ì›”')) {
        return new Date(parseInt(match[1]), parseInt(match[2]) - 1, 1);
      } else if (pattern.source.includes('ì›”.*ì¼')) {
        return new Date(new Date().getFullYear(), parseInt(match[1]) - 1, parseInt(match[2]));
      } else if (pattern.source === '(\\d{1,2})ì›”') {
        return new Date(new Date().getFullYear(), parseInt(match[1]) - 1, 1);
      } else {
        const year = parseInt(match[1]);
        const month = parseInt(match[2]) - 1;
        const day = parseInt(match[3]) || 1;
        return new Date(year, month, day);
      }
    }
  }
  
  const parsed = new Date(str);
  return isNaN(parsed.getTime()) ? null : parsed;
}

function formatDateV23(date) {
  if (!date || !(date instanceof Date)) return '';
  
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  
  return `${year}.${month}.${day}`;
}

// ========== ê¸°ë³¸ê°’ ë°˜í™˜ í•¨ìˆ˜ë“¤ v2.3 ==========

function getDefaultSummary() {
  return {
    Venue: [], Fashion: [], Photo: [], Travel:[],
    Invitation: [], Jewelry: [], Family: [], 
    Legal: [], Sound: [], Transport: [], Gift: [], // ğŸ†•
    Summary: [],
    basic: [], statistics: getDefaultStats(),
    upcomingTasks: [], budgetByCategory: {}, monthlySchedule: {},
    categoryInfo: CONFIG.CATEGORY_INFO
  };
}

function getDefaultAllData() {
  const defaultData = {};
  Object.values(CONFIG.SHEETS).forEach(sheetName => {
    defaultData[sheetName] = [];
  });
  return defaultData;
}

function getDefaultStats() {
  return {
    daysLeft: 0, totalExpectedExpense: 0, currentExpense: 0,
    completedTasks: 0, totalTasks: 0, overallProgress: 0,
    categoryStats: {}, expenseUtilization: 0
  };
}

// ========== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ v2.3 ==========

function quickTestV23() {
  console.log('ğŸ§ª v2.3 ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
  
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    console.log('âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°:', ss.getName());
    
    const summary = getSummaryV23();
    console.log('âœ… Summary v2.3 í…ŒìŠ¤íŠ¸ ì„±ê³µ');
    console.log('ğŸ“Š í†µê³„:', summary.statistics);
    console.log('ğŸ”¥ 3ê°œì›” í• ì¼:', summary.upcomingTasks.length, 'ê°œ');
    console.log('ğŸ’³ ì›”ë³„ ì¼ì •:', Object.keys(summary.monthlySchedule).length, 'ê°œì›”');
    console.log('ğŸ“‹ ì¹´í…Œê³ ë¦¬:', Object.keys(summary.categoryInfo).length, 'ê°œ');
    
    console.log('ğŸ‰ v2.3 ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ í†µê³¼!');
    return true;
    
  } catch (error) {
    console.error('âŒ v2.3 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
    return false;
  }
}
