/**
 * NYSH Wedding Project - 완전 개선 Apps Script v2.3
 * 
 * 🎯 v2.3 주요 개선사항:
 * - 새 카테고리 4개 추가 (법적절차, 음향, 교통, 축의금)
 * - 실행일 로직 완전 최적화
 * - 월별 일정 개선 (결제일 + 실행일)
 * - Summary 개선 (예상 총 지출, 진행률 UI 데이터)
 * - 메모 항상 표시 지원
 * - 계약금/잔금 분리 처리
 */

// ========== 설정 ==========
const CONFIG = {
  SHEET_ID: '13Y7RRprcp-lNjInoJHEL3q83FWw_NksjW6bHEOh4qDo',
  WEDDING_DATE: '2026-04-18',
  
  // v2.3 확장 시트 구조 정의
  SHEETS: {
    SUMMARY: 'Summary',
    VENUE: 'Venue', 
    FASHION: 'Fashion',
    PHOTO: 'Photo',
    TRAVEL: 'Travel',
    INVITATION: 'Invitation', 
    JEWELRY: 'Jewelry',
    FAMILY: 'Family',
    
    // 🆕 새로 추가된 카테고리
    LEGAL: 'Legal',        // 📋 법적절차  
    SOUND: 'Sound',        // 🎵 음향/엔터테인먼트
    TRANSPORT: 'Transport', // 🚗 교통/차량
    GIFT: 'Gift'           // 💰 축의금관리
  },
  
  // v2.3 표준 컬럼 정의 (실행일 포함)
  COLUMNS: {
    CATEGORY: '구분',
    ITEM: '항목', 
    VENDOR: '업체명',
    CONTACT: '연락처',
    DEPOSIT: '계약금',
    BALANCE: '잔금', 
    DUE_DATE: '결제일',
    EXECUTION_DATE: '실행일',     // 🆕 실행일 컬럼
    STATUS: '상태',
    NOTES: '메모'
  },
  
  // 카테고리별 아이콘 및 이름
  CATEGORY_INFO: {
    'Venue': { icon: '🏰', name: '웨딩홀' },
    'Fashion': { icon: '👗', name: '의상 & 뷰티' },
    'Photo': { icon: '📷', name: '촬영 & 영상' },
    'Travel': { icon: '✈️', name: '신혼여행' },
    'Invitation': { icon: '💌', name: '청첩장 & 하객' },
    'Jewelry': { icon: '💎', name: '예물 & 반지' },
    'Family': { icon: '👨‍👩‍👧‍👦', name: '가족 행사' },
    'Legal': { icon: '📋', name: '법적절차' },        // 🆕
    'Sound': { icon: '🎵', name: '음향/엔터테인먼트' },  // 🆕
    'Transport': { icon: '🚗', name: '교통/차량' },    // 🆕
    'Gift': { icon: '💰', name: '축의금관리' }         // 🆕
  }
};

// ========== 메인 API 엔드포인트 ==========
function doGet(e) {
  const startTime = new Date();
  
  try {
    const action = e.parameter.action || 'getSummary';
    const sheet = e.parameter.sheet;
    
    console.log(`🔄 API 호출 v2.3: ${action}`);
    
    let result;
    
    switch(action) {
      case 'getSummary':
        result = getSummaryV23();
        break;
      case 'getAllSheets':
        result = getAllSheetsV23();
        break;
      case 'getSheet':
        if (!sheet) throw new Error('시트 이름이 필요합니다');
        result = getSheetDataV23(sheet);
        break;
      case 'getStats':
        result = getWeddingStatsV23();
        break;
      case 'migrate':
        result = migrateToV23();
        break;
      case 'createNewSheets':
        result = createNewCategorySheets();
        break;
      case 'test':
        result = { message: 'API v2.3 테스트 성공!', timestamp: new Date().toISOString() };
        break;
      default:
        throw new Error(`지원하지 않는 액션: ${action}`);
    }
    
    const executionTime = new Date() - startTime;
    console.log(`✅ API 완료 v2.3: ${action} (${executionTime}ms)`);
    
    return createResponse(true, result, `v2.3 실행 시간: ${executionTime}ms`);
    
  } catch (error) {
    const executionTime = new Date() - startTime;
    console.error('❌ API 오류:', error);
    
    return createResponse(false, null, `오류: ${error.toString()} (${executionTime}ms)`);
  }
}

// ========== 응답 생성 ==========
function createResponse(success, data, message = '') {
  const response = {
    success: success,
    data: data,
    message: message,
    timestamp: new Date().toISOString(),
    version: '2.3'
  };
  
  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}

// ========== 🎯 완전 최적화된 Summary API v2.3 ==========
function getSummaryV23() {
  try {
    console.log('📊 Summary v2.3 생성 시작...');
    
    const allData = getAllSheetsV23();
    const stats = calculateStatsV23(allData);
    
    return {
      // 각 시트 데이터 (11개 카테고리)
      Venue: allData.Venue || [],
      Fashion: allData.Fashion || [],
      Photo: allData.Photo || [],
      Travel: allData.Travel || [],
      Invitation: allData.Invitation || [],
      Jewelry: allData.Jewelry || [],
      Family: allData.Family || [],
      Legal: allData.Legal || [],        // 🆕
      Sound: allData.Sound || [],        // 🆕
      Transport: allData.Transport || [], // 🆕
      Gift: allData.Gift || [],          // 🆕
      Summary: allData.Summary || [],
      
      // Summary 정보
      basic: allData.Summary || [],
      statistics: stats,
      upcomingTasks: getUpcomingTasks3MonthsV23(allData),    
      budgetByCategory: getBudgetByCategoryV23(allData),
      monthlySchedule: getMonthlyScheduleV23(allData), // 🆕 월별 일정 (실행일 포함)
      categoryInfo: CONFIG.CATEGORY_INFO // 🆕 카테고리 정보
    };
    
  } catch (error) {
    console.error('❌ Summary 생성 오류:', error);
    return getDefaultSummary();
  }
}

// ========== 🎯 최적화된 데이터 로드 v2.3 ==========
function getAllSheetsV23() {
  const allData = {};
  
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    console.log(`📊 스프레드시트 연결: ${ss.getName()}`);
    
    Object.values(CONFIG.SHEETS).forEach(sheetName => {
      try {
        const sheet = ss.getSheetByName(sheetName);
        if (sheet) {
          console.log(`📋 ${sheetName} 처리 중...`);
          allData[sheetName] = processSheetDataV23(sheet, sheetName);
          console.log(`✅ ${sheetName} 완료: ${allData[sheetName].length}개 행`);
        } else {
          console.log(`⚠️ ${sheetName} 시트 없음 - 빈 배열로 초기화`);
          allData[sheetName] = [];
        }
      } catch (error) {
        console.error(`❌ ${sheetName} 처리 실패:`, error);
        allData[sheetName] = [];
      }
    });
    
    return allData;
    
  } catch (error) {
    console.error('❌ 데이터 로드 실패:', error);
    return getDefaultAllData();
  }
}

// ========== 🎯 시트 데이터 처리 v2.3 ==========
function processSheetDataV23(sheet, sheetName) {
  try {
    const range = sheet.getDataRange();
    const values = range.getValues();
    
    if (values.length <= 1) return [];
    
    const headers = values[0].map(h => String(h).trim());
    const data = [];
    
    // 실행일 컬럼 존재 여부 확인
    const hasExecutionDate = headers.includes(CONFIG.COLUMNS.EXECUTION_DATE);
    const hasNotes = headers.includes(CONFIG.COLUMNS.NOTES);
    
    console.log(`📋 ${sheetName} 컬럼 확인 - 실행일: ${hasExecutionDate}, 메모: ${hasNotes}`);
    
    for (let i = 1; i < values.length; i++) {
      try {
        const row = {};
        let hasData = false;
        
        // 기본 데이터 매핑
        for (let j = 0; j < headers.length; j++) {
          const value = values[i][j];
          const cleanValue = cleanCellValue(value);
          row[headers[j]] = cleanValue;
          
          if (cleanValue !== '') hasData = true;
        }
        
        if (hasData && sheetName !== CONFIG.SHEETS.SUMMARY) {
          // 계산된 필드 추가
          row._totalBudget = calculateRowBudgetV23(row);
          row._deposit = parseFloat(row[CONFIG.COLUMNS.DEPOSIT]) || 0;
          row._balance = parseFloat(row[CONFIG.COLUMNS.BALANCE]) || 0;
          row._isCompleted = isStatusCompletedV23(row[CONFIG.COLUMNS.STATUS]);
          
          // 날짜 파싱 (안전하게)
          row._executionDate = hasExecutionDate ? 
            parseDateStringV23(row[CONFIG.COLUMNS.EXECUTION_DATE]) : null;
          row._dueDate = parseDateStringV23(row[CONFIG.COLUMNS.DUE_DATE]);
          row._targetDate = row._executionDate || row._dueDate || null;
          
          // 메모 처리
          row._hasNotes = hasNotes && row[CONFIG.COLUMNS.NOTES] && 
                         String(row[CONFIG.COLUMNS.NOTES]).trim() !== '';
          
          data.push(row);
        } else if (hasData) {
          data.push(row);
        }
        
      } catch (rowError) {
        console.error(`행 처리 오류 (${sheetName} ${i+1}):`, rowError);
      }
    }
    
    return data;
    
  } catch (error) {
    console.error(`시트 처리 오류 (${sheetName}):`, error);
    return [];
  }
}

// ========== 🆕 월별 일정 v2.3 (실행일 포함) ==========
function getMonthlyScheduleV23(allData) {
  const schedule = {};
  const today = new Date();
  const weddingDate = new Date(CONFIG.WEDDING_DATE);
  
  if (!allData || typeof allData !== 'object') {
    return {};
  }
  
  Object.keys(allData).forEach(category => {
    if (category === CONFIG.SHEETS.SUMMARY) return;
    
    const categoryData = allData[category];
    if (!Array.isArray(categoryData)) return;
    
    categoryData.forEach(row => {
      if (!row || typeof row !== 'object' || row._isCompleted) return;
      
      const paymentDate = row._dueDate;
      if (!paymentDate || !(paymentDate instanceof Date)) return;
      if (paymentDate < today || paymentDate > weddingDate) return;
      
      const monthKey = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
      
      if (!schedule[monthKey]) {
        schedule[monthKey] = [];
      }
      
      const budget = Math.round((row._totalBudget || 0) / 10000);
      
      if (budget > 0) {
        schedule[monthKey].push({
          category: category,
          item: row[CONFIG.COLUMNS.ITEM] || '',
          paymentDate: formatDateV23(paymentDate),
          executionDate: row._executionDate ? formatDateV23(row._executionDate) : '', // 🆕 실행일
          budget: budget,
          deposit: Math.round((row._deposit || 0) / 10000),
          balance: Math.round((row._balance || 0) / 10000),
          status: row[CONFIG.COLUMNS.STATUS] || '미정',
          vendor: row[CONFIG.COLUMNS.VENDOR] || '',
          notes: row[CONFIG.COLUMNS.NOTES] || '' // 🆕 메모
        });
      }
    });
  });
  
  // 각 월별로 결제일 순 정렬
  Object.keys(schedule).forEach(monthKey => {
    if (Array.isArray(schedule[monthKey])) {
      schedule[monthKey].sort((a, b) => new Date(a.paymentDate) - new Date(b.paymentDate));
    }
  });
  
  return schedule;
}

// ========== 🆕 3개월 내 할일 v2.3 (실행일 우선) ==========
function getUpcomingTasks3MonthsV23(allData) {
  const tasks = [];
  const today = new Date();
  const threeMonthsLater = new Date(today.getTime() + (90 * 24 * 60 * 60 * 1000));
  
  if (!allData || typeof allData !== 'object') {
    return [];
  }
  
  Object.keys(allData).forEach(category => {
    if (category === CONFIG.SHEETS.SUMMARY) return;
    
    const categoryData = allData[category];
    if (!Array.isArray(categoryData)) return;
    
    categoryData.forEach(row => {
      if (!row || typeof row !== 'object' || row._isCompleted) return;
      
      const targetDate = row._targetDate;
      if (!targetDate || !(targetDate instanceof Date)) return;
      
      if (targetDate <= threeMonthsLater) {
        tasks.push({
          category: category,
          item: row[CONFIG.COLUMNS.ITEM] || '',
          paymentDate: row._dueDate ? formatDateV23(row._dueDate) : '',
          executionDate: row._executionDate ? formatDateV23(row._executionDate) : '', // 🆕
          status: row[CONFIG.COLUMNS.STATUS] || '',
          priority: calculatePriorityV23(targetDate, today),
          vendor: row[CONFIG.COLUMNS.VENDOR] || '',
          targetDate: targetDate,
          notes: row[CONFIG.COLUMNS.NOTES] || '' // 🆕 메모
        });
      }
    });
  });
  
  return tasks
    .sort((a, b) => {
      const dateA = a.targetDate instanceof Date ? a.targetDate : new Date(0);
      const dateB = b.targetDate instanceof Date ? b.targetDate : new Date(0);
      return dateA - dateB;
    })
    .slice(0, 12); // 더 많이 표시
}

// ========== 🎯 통계 계산 v2.3 (예상 총 지출) ==========
function calculateStatsV23(allData) {
  try {
    let totalExpectedExpense = 0; // 🆕 예상 총 지출
    let currentExpense = 0; 
    let completedTasks = 0;
    let totalTasks = 0;
    
    const categoryStats = {};
    
    if (!allData || typeof allData !== 'object') {
      return getDefaultStats();
    }
    
    Object.keys(allData).forEach(sheetName => {
      if (sheetName === CONFIG.SHEETS.SUMMARY) return;
      
      const data = allData[sheetName];
      
      if (!Array.isArray(data)) {
        categoryStats[sheetName] = { 
          budget: 0, completed: 0, total: 0, progress: 0,
          icon: CONFIG.CATEGORY_INFO[sheetName]?.icon || '📋',
          name: CONFIG.CATEGORY_INFO[sheetName]?.name || sheetName
        };
        return;
      }
      
      let categoryBudget = 0;
      let categoryCompleted = 0;
      
      data.forEach(row => {
        if (!row || typeof row !== 'object') return;
        
        const budget = typeof row._totalBudget === 'number' ? row._totalBudget : 0;
        totalExpectedExpense += budget; // 🆕 모든 예산 합계
        
        if (row._isCompleted === true) {
          currentExpense += budget;
          completedTasks++;
          categoryCompleted++;
        }
        
        totalTasks++;
        categoryBudget += budget;
      });
      
      categoryStats[sheetName] = {
        budget: categoryBudget,
        completed: categoryCompleted,
        total: data.length,
        progress: data.length > 0 ? Math.round((categoryCompleted / data.length) * 100) : 0,
        icon: CONFIG.CATEGORY_INFO[sheetName]?.icon || '📋',
        name: CONFIG.CATEGORY_INFO[sheetName]?.name || sheetName
      };
    });
    
    // D-Day 계산
    const weddingDate = new Date(CONFIG.WEDDING_DATE);
    const today = new Date();
    const daysLeft = Math.ceil((weddingDate - today) / (1000 * 60 * 60 * 24));
    
    return {
      daysLeft: daysLeft > 0 ? daysLeft : 0,
      totalExpectedExpense: Math.round(totalExpectedExpense / 10000), // 🆕 예상 총 지출
      currentExpense: Math.round(currentExpense / 10000),
      completedTasks: completedTasks,
      totalTasks: totalTasks,
      overallProgress: totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0,
      categoryStats: categoryStats,
      expenseUtilization: totalExpectedExpense > 0 ? 
        Math.round((currentExpense / totalExpectedExpense) * 100) : 0
    };
    
  } catch (error) {
    console.error('통계 계산 오류:', error);
    return getDefaultStats();
  }
}

// ========== 🚀 v2.3 마이그레이션 (새 카테고리 + 실행일) ==========
function migrateToV23() {
  console.log('🚀 v2.3 마이그레이션 시작...');
  
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const results = [];
    
    // 1. 새 카테고리 시트 생성
    results.push(createNewCategorySheets());
    
    // 2. 기존 시트에 실행일 컬럼 추가
    const allSheets = Object.values(CONFIG.SHEETS).filter(name => name !== 'Summary');
    
    allSheets.forEach(sheetName => {
      try {
        const sheet = ss.getSheetByName(sheetName);
        if (sheet) {
          const result = addExecutionDateColumnV23(sheet, sheetName);
          results.push(result);
        }
      } catch (error) {
        console.error(`${sheetName} 마이그레이션 실패:`, error);
        results.push(`❌ ${sheetName}: ${error.message}`);
      }
    });
    
    // 3. Summary 시트 업데이트
    results.push(updateSummarySheetV23(ss));
    
    console.log('✅ v2.3 마이그레이션 완료');
    
    return {
      success: true,
      message: 'v2.3 마이그레이션 완료 (새 카테고리 + 실행일)',
      results: results,
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('❌ 마이그레이션 실패:', error);
    return {
      success: false,
      message: error.toString(),
      results: [],
      timestamp: new Date().toISOString()
    };
  }
}

// ========== 🆕 새 카테고리 시트 생성 ==========
function createNewCategorySheets() {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const newCategories = ['Legal', 'Sound', 'Transport', 'Gift'];
    const results = [];
    
    newCategories.forEach(categoryName => {
      try {
        let sheet = ss.getSheetByName(categoryName);
        
        if (!sheet) {
          // 새 시트 생성
          sheet = ss.insertSheet(categoryName);
          
          // 헤더 설정
          const headers = Object.values(CONFIG.COLUMNS);
          sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
          
          // 헤더 스타일 적용
          const headerRange = sheet.getRange(1, 1, 1, headers.length);
          headerRange.setBackground('#667eea')
                    .setFontColor('white')
                    .setFontWeight('bold')
                    .setFontSize(11)
                    .setHorizontalAlignment('center');
          
          // 상태 컬럼에 데이터 검증 추가
          const statusColIndex = headers.indexOf(CONFIG.COLUMNS.STATUS) + 1;
          if (statusColIndex > 0) {
            const validation = SpreadsheetApp.newDataValidation()
              .requireValueInList(['완료', '진행중', '미정'], true)
              .setAllowInvalid(false)
              .setHelpText('상태를 선택하세요: 완료, 진행중, 미정')
              .build();
            
            const statusRange = sheet.getRange(2, statusColIndex, 50, 1);
            statusRange.setDataValidation(validation);
          }
          
          // 컬럼 너비 자동 조정
          sheet.autoResizeColumns(1, headers.length);
          
          results.push(`✅ ${categoryName}: 새 시트 생성 완료`);
        } else {
          results.push(`⚠️ ${categoryName}: 이미 존재하는 시트`);
        }
        
      } catch (error) {
        console.error(`${categoryName} 시트 생성 실패:`, error);
        results.push(`❌ ${categoryName}: ${error.message}`);
      }
    });
    
    return results.join(', ');
    
  } catch (error) {
    console.error('새 카테고리 시트 생성 실패:', error);
    return `❌ 새 카테고리 시트 생성 실패: ${error.message}`;
  }
}

// ========== 실행일 컬럼 추가 v2.3 ==========
function addExecutionDateColumnV23(sheet, sheetName) {
  try {
    const range = sheet.getDataRange();
    const values = range.getValues();
    
    if (values.length === 0) {
      return `⚠️ ${sheetName}: 데이터가 없습니다`;
    }
    
    const headers = values[0];
    
    // 이미 실행일 컬럼이 있는지 확인
    if (headers.includes('실행일')) {
      return `✅ ${sheetName}: 실행일 컬럼이 이미 존재합니다`;
    }
    
    // 결제일 컬럼 위치 찾기
    const dueDateIndex = headers.indexOf('결제일');
    
    if (dueDateIndex === -1) {
      return `⚠️ ${sheetName}: 결제일 컬럼을 찾을 수 없습니다`;
    }
    
    // 실행일 컬럼을 결제일 다음에 삽입
    const insertIndex = dueDateIndex + 2;
    
    // 컬럼 삽입
    sheet.insertColumnAfter(dueDateIndex + 1);
    
    // 헤더 설정
    sheet.getRange(1, insertIndex).setValue('실행일');
    
    // 헤더 스타일 적용
    const headerRange = sheet.getRange(1, insertIndex);
    headerRange.setBackground('#667eea')
              .setFontColor('white')
              .setFontWeight('bold')
              .setFontSize(11)
              .setHorizontalAlignment('center');
    
    // 상태 컬럼 드롭다운 다시 설정 (컬럼이 밀렸으므로)
    const statusColIndex = headers.indexOf('상태') + (insertIndex <= headers.indexOf('상태') + 1 ? 2 : 1);
    if (statusColIndex > 0) {
      const statusRange = sheet.getRange(2, statusColIndex, sheet.getLastRow() - 1, 1);
      const validation = SpreadsheetApp.newDataValidation()
        .requireValueInList(['완료', '진행중', '미정'], true)
        .setAllowInvalid(false)
        .setHelpText('상태를 선택하세요: 완료, 진행중, 미정')
        .build();
      
      statusRange.setDataValidation(validation);
    }
    
    // 컬럼 너비 자동 조정
    sheet.autoResizeColumns(1, sheet.getLastColumn());
    
    return `✅ ${sheetName}: 실행일 컬럼 추가 완료`;
    
  } catch (error) {
    console.error(`실행일 컬럼 추가 실패 (${sheetName}):`, error);
    return `❌ ${sheetName}: ${error.message}`;
  }
}

// ========== Summary 시트 업데이트 v2.3 ==========
function updateSummarySheetV23(ss) {
  try {
    let sheet = ss.getSheetByName('Summary');
    
    if (!sheet) {
      sheet = ss.insertSheet('Summary');
    }
    
    // 기존 내용 삭제
    sheet.clear();
    
    // v2.3 Summary 구조 생성 (11개 카테고리 포함)
    const summaryData = [
      ['항목', '값', '항목', '값'],
      ['D-Day', '=DAYS("2026-04-18",TODAY())&"일"', '전체진행률', '=ROUND(AVERAGE(D13:D23),0)&"%"'],
      ['예상총지출', '=ROUND((SUM(Venue!E:E,Venue!F:F,Fashion!E:E,Fashion!F:F,Photo!E:E,Photo!F:F,Travel!E:E,Travel!F:F,Invitation!E:E,Invitation!F:F,Jewelry!E:E,Jewelry!F:F,Family!E:E,Family!F:F,Legal!E:E,Legal!F:F,Sound!E:E,Sound!F:F,Transport!E:E,Transport!F:F,Gift!E:E,Gift!F:F))/10000,0)&"만원"', '현재지출', '=ROUND((SUMIFS(Venue!E:E,Venue!I:I,"*완료*")+SUMIFS(Venue!F:F,Venue!I:I,"*완료*")+SUMIFS(Fashion!E:E,Fashion!I:I,"*완료*")+SUMIFS(Fashion!F:F,Fashion!I:I,"*완료*")+SUMIFS(Photo!E:E,Photo!I:I,"*완료*")+SUMIFS(Photo!F:F,Photo!I:I,"*완료*")+SUMIFS(Travel!E:E,Travel!I:I,"*완료*")+SUMIFS(Travel!F:F,Travel!I:I,"*완료*")+SUMIFS(Invitation!E:E,Invitation!I:I,"*완료*")+SUMIFS(Invitation!F:F,Invitation!I:I,"*완료*")+SUMIFS(Jewelry!E:E,Jewelry!I:I,"*완료*")+SUMIFS(Jewelry!F:F,Jewelry!I:I,"*완료*")+SUMIFS(Family!E:E,Family!I:I,"*완료*")+SUMIFS(Family!F:F,Family!I:I,"*완료*")+SUMIFS(Legal!E:E,Legal!I:I,"*완료*")+SUMIFS(Legal!F:F,Legal!I:I,"*완료*")+SUMIFS(Sound!E:E,Sound!I:I,"*완료*")+SUMIFS(Sound!F:F,Sound!I:I,"*완료*")+SUMIFS(Transport!E:E,Transport!I:I,"*완료*")+SUMIFS(Transport!F:F,Transport!I:I,"*완료*")+SUMIFS(Gift!E:E,Gift!I:I,"*완료*")+SUMIFS(Gift!F:F,Gift!I:I,"*완료*"))/10000,0)&"만원"'],
      ['웨딩홀', '강변웨딩스퀘어', '웨딩날짜', '2026.4.18'],
      ['신부', '김나영', '신랑', '이상현'],
      ['플래너', '베리굿 봄도영실장', '진행상태', '=IF(D2="100%","완료!","진행중")'],
      ['', '', '', ''],
      ['카테고리별 현황 (v2.3)', '', '', ''],
      ['카테고리', '완료 현황', '', '진행률'],
      ['🏰 웨딩홀', '=COUNTIFS(Venue!I:I,"*완료*")&"/"&(COUNTA(Venue!A:A)-1)&" 완료"', '', '=IF(COUNTA(Venue!A:A)>1,ROUND(COUNTIFS(Venue!I:I,"*완료*")/(COUNTA(Venue!A:A)-1)*100,0),0)'],
      ['👗 의상뷰티', '=COUNTIFS(Fashion!I:I,"*완료*")&"/"&(COUNTA(Fashion!A:A)-1)&" 완료"', '', '=IF(COUNTA(Fashion!A:A)>1,ROUND(COUNTIFS(Fashion!I:I,"*완료*")/(COUNTA(Fashion!A:A)-1)*100,0),0)'],
      ['📷 촬영영상', '=COUNTIFS(Photo!I:I,"*완료*")&"/"&(COUNTA(Photo!A:A)-1)&" 완료"', '', '=IF(COUNTA(Photo!A:A)>1,ROUND(COUNTIFS(Photo!I:I,"*완료*")/(COUNTA(Photo!A:A)-1)*100,0),0)'],
      ['✈️ 신혼여행', '=COUNTIFS(Travel!I:I,"*완료*")&"/"&(COUNTA(Travel!A:A)-1)&" 완료"', '', '=IF(COUNTA(Travel!A:A)>1,ROUND(COUNTIFS(Travel!I:I,"*완료*")/(COUNTA(Travel!A:A)-1)*100,0),0)'],
      ['💌 청첩장', '=COUNTIFS(Invitation!I:I,"*완료*")&"/"&(COUNTA(Invitation!A:A)-1)&" 완료"', '', '=IF(COUNTA(Invitation!A:A)>1,ROUND(COUNTIFS(Invitation!I:I,"*완료*")/(COUNTA(Invitation!A:A)-1)*100,0),0)'],
      ['💎 예물반지', '=COUNTIFS(Jewelry!I:I,"*완료*")&"/"&(COUNTA(Jewelry!A:A)-1)&" 완료"', '', '=IF(COUNTA(Jewelry!A:A)>1,ROUND(COUNTIFS(Jewelry!I:I,"*완료*")/(COUNTA(Jewelry!A:A)-1)*100,0),0)'],
      ['👨‍👩‍👧‍👦 가족행사', '=COUNTIFS(Family!I:I,"*완료*")&"/"&(COUNTA(Family!A:A)-1)&" 완료"', '', '=IF(COUNTA(Family!A:A)>1,ROUND(COUNTIFS(Family!I:I,"*완료*")/(COUNTA(Family!A:A)-1)*100,0),0)'],
      ['📋 법적절차', '=COUNTIFS(Legal!I:I,"*완료*")&"/"&(COUNTA(Legal!A:A)-1)&" 완료"', '', '=IF(COUNTA(Legal!A:A)>1,ROUND(COUNTIFS(Legal!I:I,"*완료*")/(COUNTA(Legal!A:A)-1)*100,0),0)'],
      ['🎵 음향엔터', '=COUNTIFS(Sound!I:I,"*완료*")&"/"&(COUNTA(Sound!A:A)-1)&" 완료"', '', '=IF(COUNTA(Sound!A:A)>1,ROUND(COUNTIFS(Sound!I:I,"*완료*")/(COUNTA(Sound!A:A)-1)*100,0),0)'],
      ['🚗 교통차량', '=COUNTIFS(Transport!I:I,"*완료*")&"/"&(COUNTA(Transport!A:A)-1)&" 완료"', '', '=IF(COUNTA(Transport!A:A)>1,ROUND(COUNTIFS(Transport!I:I,"*완료*")/(COUNTA(Transport!A:A)-1)*100,0),0)'],
      ['💰 축의금관리', '=COUNTIFS(Gift!I:I,"*완료*")&"/"&(COUNTA(Gift!A:A)-1)&" 완료"', '', '=IF(COUNTA(Gift!A:A)>1,ROUND(COUNTIFS(Gift!I:I,"*완료*")/(COUNTA(Gift!A:A)-1)*100,0),0)']
    ];
    
    // 데이터 입력
    sheet.getRange(1, 1, summaryData.length, 4).setValues(summaryData);
    
    // 스타일 적용
    applySummaryStylesV23(sheet);
    
    return '✅ Summary: v2.3 구조로 업데이트 완료 (11개 카테고리)';
    
  } catch (error) {
    console.error('Summary 업데이트 실패:', error);
    return `❌ Summary: ${error.message}`;
  }
}

// ========== Summary 스타일 적용 v2.3 ==========
function applySummaryStylesV23(sheet) {
  // 헤더 스타일
  const headerRange = sheet.getRange('A1:D1');
  headerRange.setBackground('#667eea')
           .setFontColor('white')
           .setFontWeight('bold')
           .setFontSize(12);
  
  // 카테고리 제목 스타일
  const categoryHeaderRange = sheet.getRange('A9:D9');
  categoryHeaderRange.setBackground('#f8f9fa')
                    .setFontWeight('bold')
                    .setFontSize(14);
  
  // 카테고리 서브헤더 스타일
  const subHeaderRange = sheet.getRange('A10:D10');
  subHeaderRange.setBackground('#e9ecef')
               .setFontWeight('bold')
               .setFontSize(10);
  
  // 조건부 서식 (진행률) - 11개 카테고리 반영
  const progressRange = sheet.getRange('D11:D21');
  
  const rules = [
    SpreadsheetApp.newConditionalFormatRule()
      .whenNumberEqualTo(100)
      .setBackground('#d1e7dd')
      .setFontColor('#0f5132')
      .setRanges([progressRange])
      .build(),
    SpreadsheetApp.newConditionalFormatRule()
      .whenNumberGreaterThanOrEqualTo(50)
      .setBackground('#fff3cd')
      .setFontColor('#664d03')
      .setRanges([progressRange])
      .build(),
    SpreadsheetApp.newConditionalFormatRule()
      .whenNumberLessThan(50)
      .setBackground('#f8d7da')
      .setFontColor('#721c24')
      .setRanges([progressRange])
      .build()
  ];
  
  sheet.setConditionalFormatRules(rules);
  sheet.autoResizeColumns(1, 4);
}

// ========== 개별 시트 데이터 v2.3 ==========
function getSheetDataV23(sheetName) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
      throw new Error(`시트를 찾을 수 없습니다: ${sheetName}`);
    }
    
    return processSheetDataV23(sheet, sheetName);
    
  } catch (error) {
    console.error(`시트 데이터 로드 실패 (${sheetName}):`, error);
    return [];
  }
}

// ========== 통계만 반환 v2.3 ==========
function getWeddingStatsV23() {
  try {
    const allData = getAllSheetsV23();
    return calculateStatsV23(allData);
  } catch (error) {
    console.error('통계 로드 실패:', error);
    return getDefaultStats();
  }
}

// ========== 카테고리별 예산 v2.3 ==========
function getBudgetByCategoryV23(allData) {
  const budgetByCategory = {};
  
  try {
    if (!allData || typeof allData !== 'object') {
      return {};
    }
    
    Object.keys(allData).forEach(category => {
      if (category === CONFIG.SHEETS.SUMMARY) return;
      
      const categoryData = allData[category];
      if (!Array.isArray(categoryData)) return;
      
      const totalBudget = categoryData.reduce((sum, row) => {
        if (!row || typeof row !== 'object') return sum;
        const budget = typeof row._totalBudget === 'number' ? row._totalBudget : 0;
        return sum + budget;
      }, 0);
      
      if (totalBudget > 0) {
        budgetByCategory[category] = Math.round(totalBudget / 10000);
      }
    });
    
    return budgetByCategory;
    
  } catch (error) {
    console.error('카테고리별 예산 계산 오류:', error);
    return {};
  }
}

// ========== 유틸리티 함수들 v2.3 ==========

function cleanCellValue(value) {
  if (value === null || value === undefined) return '';
  if (typeof value === 'number') return value;
  if (value instanceof Date) return formatDateV23(value);
  return String(value).trim();
}

function calculateRowBudgetV23(row) {
  const deposit = parseFloat(row[CONFIG.COLUMNS.DEPOSIT]) || 0;
  const balance = parseFloat(row[CONFIG.COLUMNS.BALANCE]) || 0;
  return deposit + balance;
}

function isStatusCompletedV23(status) {
  if (!status) return false;
  return String(status).includes('완료');
}

function calculatePriorityV23(targetDate, today) {
  const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
  
  if (daysUntil < 0) return 100;
  if (daysUntil <= 7) return 95;
  if (daysUntil <= 14) return 90;
  if (daysUntil <= 30) return 80;
  if (daysUntil <= 60) return 70;
  return 60;
}

function parseDateStringV23(dateStr) {
  if (!dateStr) return null;
  
  const str = String(dateStr).trim();
  if (!str) return null;
  
  const patterns = [
    /(\d{4})\.(\d{1,2})\.(\d{1,2})/,
    /(\d{4})-(\d{1,2})-(\d{1,2})/,
    /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
    /(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일/,
    /(\d{4})년\s*(\d{1,2})월/,
    /(\d{1,2})월\s*(\d{1,2})일/,
    /(\d{1,2})월/
  ];
  
  for (let pattern of patterns) {
    const match = str.match(pattern);
    if (match) {
      if (pattern.source.includes('년.*월.*일')) {
        return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
      } else if (pattern.source.includes('년.*월')) {
        return new Date(parseInt(match[1]), parseInt(match[2]) - 1, 1);
      } else if (pattern.source.includes('월.*일')) {
        return new Date(new Date().getFullYear(), parseInt(match[1]) - 1, parseInt(match[2]));
      } else if (pattern.source === '(\\d{1,2})월') {
        return new Date(new Date().getFullYear(), parseInt(match[1]) - 1, 1);
      } else {
        const year = parseInt(match[1]);
        const month = parseInt(match[2]) - 1;
        const day = parseInt(match[3]) || 1;
        return new Date(year, month, day);
      }
    }
  }
  
  const parsed = new Date(str);
  return isNaN(parsed.getTime()) ? null : parsed;
}

function formatDateV23(date) {
  if (!date || !(date instanceof Date)) return '';
  
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  
  return `${year}.${month}.${day}`;
}

// ========== 기본값 반환 함수들 v2.3 ==========

function getDefaultSummary() {
  return {
    Venue: [], Fashion: [], Photo: [], Travel:[],
    Invitation: [], Jewelry: [], Family: [], 
    Legal: [], Sound: [], Transport: [], Gift: [], // 🆕
    Summary: [],
    basic: [], statistics: getDefaultStats(),
    upcomingTasks: [], budgetByCategory: {}, monthlySchedule: {},
    categoryInfo: CONFIG.CATEGORY_INFO
  };
}

function getDefaultAllData() {
  const defaultData = {};
  Object.values(CONFIG.SHEETS).forEach(sheetName => {
    defaultData[sheetName] = [];
  });
  return defaultData;
}

function getDefaultStats() {
  return {
    daysLeft: 0, totalExpectedExpense: 0, currentExpense: 0,
    completedTasks: 0, totalTasks: 0, overallProgress: 0,
    categoryStats: {}, expenseUtilization: 0
  };
}

// ========== 테스트 함수들 v2.3 ==========

function quickTestV23() {
  console.log('🧪 v2.3 빠른 테스트 시작...');
  
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    console.log('✅ 스프레드시트 연결:', ss.getName());
    
    const summary = getSummaryV23();
    console.log('✅ Summary v2.3 테스트 성공');
    console.log('📊 통계:', summary.statistics);
    console.log('🔥 3개월 할일:', summary.upcomingTasks.length, '개');
    console.log('💳 월별 일정:', Object.keys(summary.monthlySchedule).length, '개월');
    console.log('📋 카테고리:', Object.keys(summary.categoryInfo).length, '개');
    
    console.log('🎉 v2.3 빠른 테스트 통과!');
    return true;
    
  } catch (error) {
    console.error('❌ v2.3 테스트 실패:', error);
    return false;
  }
}
